name: github-action-demo # 工作流名称
on:
  push:
    branches:
      - develop # 生效分支
jobs:
  first-github-job: # 任务名称 自定义
    runs-on: ubuntu-latest # 运行环境
    steps:
      - name: Checkout
        uses: actions/checkout@v3 #复用的 action 会把仓库代码检出到 runner 中。

      - name: Use Node.js
        uses: actions/setup-node@v3 # 设置nodejs版本号
        with:
          node-versions: "14.19.1"

      # 压缩项目
      - name: Build project
        run: zip -vr my-artifact ./**

      # 读取package.json的值
      - name: Read Version
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version

      # 发布 Release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        with:
          tag_name: v${{steps.version.outputs.value}}
          release_name: v${{steps.version.outputs.value}}
          draft: false
          prerelease: false

      # 上传构建结果到 Release
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./my-artifact.zip
          asset_name: my-artifact.zip
          asset_content_type: application/zip

      # 执行部署任务
      # - name: Deploy to Server
      #   uses: cross-the-world/ssh-scp-ssh-pipelines@latest
      #   with:
      #     host: ${{ secrets.HOST }}
      #     user: ${{secrets.USERNAME}}
      #     port: ${{ secrets.PORT }}
      #     key: ${{ secrets.DEPLOY_TOKEN }}

      #     # 由于网路情况，很容易超时，设置为60s
      #     connect_timeout:
      #       60s

      #       # 将工作目录下的文件全部拷贝到部署服务器的工作目录
      #     scp: |
      #       ./** => /apps/koa-koa
      #     # 完成拷贝后在部署服务器执行的命令：进入项目目录，安装生产依赖，并使用 pm2 管理
      #     last_ssh: |
      #       cd /apps/koa-koa
      #       echo "==="
      #       ln -s /usr/local/node/bin /usr/local/bin
      #       echo $PATH
      #       node -v
      #       whereis node
      #       npm install --production
      #       pm2 reload koatest.json

      # 把文件上传到服务器
      - name: Upload to Deploy Server
        uses: easingthemes/ssh-deploy@main
        env:
          # SSH_PRIVATE_KEY为准备工作步骤三中生成密钥对里的私钥
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_TOKEN }}
          # 指定当前目录中要上传的内容
          SOURCE: "./**"
          # 指定上传到部署机器的哪个目录下
          TARGET: "/apps/koa-koa"
          # 上传前指令，此处用于清空TARGET下的文件
          ARGS: "-avzr --delete"
          # REMOTE_HOST为机器的公网IP
          REMOTE_HOST: ${{ secrets.HOST }}
          # REMOTE_USER 为登录机器时用到账号名
          REMOTE_USER: ${{secrets.USERNAME}}

          # 排除上传的文件 用,隔开
          EXCLUDE: my-artifact.zip

          SCRIPT_AFTER: |
            docker stop ddb9a897df08
            docker rm ddb9a897df08
            docker pull yydsyyll/auto-deploy-koa:0.01
            docker images
            docker run -d --name my-koa -p 5000:5000 -v /apps/koa-koa:/apps/koa-koa auto-deploy-koa:0.01

      # 部署服务器
      # - name: connect host
      #   uses: appleboy/ssh-action@v0.1.10 # 使用ssh链接服务器
      #   with:
      #     host: ${{ secrets.HOST }}
      #     username: ${{ secrets.USERNAME }}
      #     # password: ${{ secrets.PASSWORD }}
      #     key: ${{ secrets.DEPLOY_TOKEN }}
      #     port: ${{ secrets.PORT }}
      #     script: |
      #       cd /apps/koa-koa
      #       echo "==="
      #       export NVM_DIR=~/.nvm
      #       source ~/.nvm/nvm.sh
      #       echo $PATH
      #       node -v
      #       pwd
      #       npm install --production
      #       npm i -g pm2
      #       pm2 reload koatest.json
